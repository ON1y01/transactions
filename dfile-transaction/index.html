<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Перевод токенов</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script src="js/web3.min.js"></script>
</head>
<body>
	<div class="container">
        <!-- <input id="NodeInfo" type="text"> -->
        <!-- <label for="name" class="col-lg-2 control-label" id="Account"></label> -->
		<div class="df-account">
			<div class="df-account__block">
				<h2>Счет :</h2>
				<input id="accountIn" type="text">
			</div>
			<div class="df-account__block">
				<h2>Баланс :</h2>
				<input id="balanceIn" type="text">
			</div>
		</div>
		<button id="balanceBtn">Показать баланс</button>

		<div class="df-account">
			<div class="df-account__block">
				<h2>Signature :</h2>
				<input id="message" type="text"></input>
			</div>
		</div>
		<button id="signIn">Sign & Send</button>
		<h2>message : <span id="msg"></span></h2>
		<h2>signature : <span id="signature"></span></h2>


		<label for="name" class="col-lg-2 control-label"><h2>Перевод</h2></label>
		<h2>Откуда :</h2>
        <input id="From" type="text">
		<h2>Куда :</h2>
        <input id="To" type="text">
        <h2>Сумма :</h2>
        <input id="Amount" type="text">
        <button id="perevesti">Перевести</button>
		<h2>Номер транзакции : <span id="tranHash"></span></h2>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

    <script>
    
		$( document ).ready(function() {
			console.log( "ready!" );
			
			if (typeof web3 !== 'undefined') {
				web3 = new Web3(web3.currentProvider);
			} else {

				web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
			}
			web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));

			

			web3.eth.getAccounts(function(error, accounts) {
				if(error) {
					console.log(error);
				}
				
				$('#accountIn').val(accounts[0]);
				web3.eth.getBalance(accounts[0]).then(function(result){
					console.log( "Balance : " ,web3.utils.fromWei(result, 'ether'));
					$('#balanceIn').val(web3.utils.fromWei(result, 'ether'));
				});
			});
			
			$('#balanceBtn').click(function() {
			    var _account = $('#accountIn').val();
				web3.eth.getBalance(_account).then(function(result){
					console.log( "Balance : " ,web3.utils.fromWei(result, 'ether'));
					$('#balanceIn').val(web3.utils.fromWei(result, 'ether'));
				});
			});
			
			
			$('#perevesti').click(function() {
				$('#tranHash').text('');
				var _from = $('#From').val();
			    var _to = $('#To').val();
				var _Amount = $('#Amount').val();
				var txnObject = {
					"from":_from,
					"to": _to,
					"value": web3.utils.toWei(_Amount,'ether'),
				}
			
				web3.eth.sendTransaction(txnObject, function(error, result){
					if(error){
						console.log( "Transaction error" ,error);
					}
					else{
						var txn_hash = result;
						$('#tranHash').text(txn_hash);
					}
				});
				
			});
			
			$('#signIn').click(function() {
				console.log($('#message').val());
				const Messages = $('#message').val();
				const message = web3.utils.sha3($('#message').val())
				console.log(message);
				web3.eth.getAccounts(function(error, accounts) {
					if(error) {
						console.log(error);
					}
					
					console.log(web3.eth.accounts.sign(Messages, message).signature);
					$('#signature').text(web3.eth.accounts.sign(Messages, message).signature);
				});
			});
		
		});
	
    </script>

</body>
</html>